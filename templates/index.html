<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Printer Job Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-active { background-color: #4f46e5; color: white; }
        .tab-inactive { background-color: #e5e7eb; color: #374151; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-2xl">
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900">3D Printer Job Log</h1>
                <p class="text-gray-500 mt-2">Select a print type and enter the job details to generate a receipt.</p>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <div class="mb-6 space-y-3">
                {% for category, message in messages %}
                  <div class="p-4 rounded-lg {% if category == 'error' %} bg-red-100 text-red-800 {% elif category == 'info' %} bg-blue-100 text-blue-800 {% else %} bg-green-100 text-green-800 {% endif %}">
                    {{ message }}
                  </div>
                {% endfor %}
                </div>
              {% endif %}
            {% endwith %}
            
            <div class="mb-6 flex border-b border-gray-200">
                <button id="fdm-tab" class="flex-1 py-2 px-4 text-center font-semibold rounded-t-lg tab-active" onclick="showForm('FDM')">FDM</button>
                <button id="resin-tab" class="flex-1 py-2 px-4 text-center font-semibold rounded-t-lg tab-inactive" onclick="showForm('Resin')">Resin</button>
            </div>

            <form action="/" method="post" enctype="multipart/form-data" class="space-y-6">
                <input type="hidden" id="print_type" name="print_type" value="FDM">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="user_name" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                        <input type="text" name="user_name" id="user_name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                    <div>
                        <label for="user_email" class="block text-sm font-medium text-gray-700 mb-1">Your Email</label>
                        <input type="email" name="user_email" id="user_email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                </div>
                <div>
                    <label for="gcode_file" class="block text-sm font-medium text-gray-700 mb-1">Print File (.gcode, .stl, .bgcode) (Optional)</label> 
                    <input type="file" name="gcode_file" id="gcode_file" accept=".gcode,.bgcode,.stl" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>

                <div id="fdm-form" class="space-y-6">
                    <div>
                        <label for="fdm_printer" class="block text-sm font-medium text-gray-700 mb-1">Printer</label>
                        <select name="fdm_printer" id="fdm_printer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option>Prusa MK4S</option>
                            <option>Prusa XL</option>
                            <option>Ultimaker S5 Pro</option>
                            <option>Markforged Mark Two</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                        <div>
                            <label for="filament_type" class="block text-sm font-medium text-gray-700 mb-1">Filament Type</label>
                            <select name="filament_type" id="filament_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                                <option value="PLA">PLA</option>
                                <option value="PLA+">PLA+</option>
                                <option value="PETG">PETG</option>
                                <option value="TPU">TPU</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div id="other_filament_type_wrapper" class="hidden">
                            <label for="other_filament_type" class="block text-sm font-medium text-gray-700 mb-1">Specify Other Filament</label>
                            <input type="text" name="other_filament_type" id="other_filament_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="filament_brand" class="block text-sm font-medium text-gray-700 mb-1">Filament Brand</label>
                            <input type="text" name="filament_brand" id="filament_brand" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                        <div>
                            <label for="filament_color" class="block text-sm font-medium text-gray-700 mb-1">Filament Color</label>
                            <input type="text" name="filament_color" id="filament_color" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                    </div>
                    <div>
                        <label for="filament_amount" class="block text-sm font-medium text-gray-700 mb-1">Filament Amount (grams)</label>
                        <input type="number" name="filament_amount" id="filament_amount" min="0" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filament Source</label>
                        <div id="filament_source_group" class="flex flex-wrap items-center gap-x-6 gap-y-2">
                            <label class="flex items-center"><input type="radio" name="filament_source" value="Lab" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked> <span class="ml-2 text-sm text-gray-600">Lab</span></label>
                            <label class="flex items-center"><input type="radio" name="filament_source" value="Class" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-2 text-sm text-gray-600">Class</span></label>
                            <label class="flex items-center"><input type="radio" name="filament_source" value="Club" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-2 text-sm text-gray-600">Club</span></label>
                            <label class="flex items-center"><input type="radio" name="filament_source" value="Personal" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-2 text-sm text-gray-600">Personal</span></label>
                        </div>
                    </div>
                    <div id="custom_cost_fdm_wrapper" class="hidden">
                        <label for="custom_cost_fdm" class="block text-sm font-medium text-gray-700 mb-1">Custom Cost per Gram ($)</label>
                        <input type="number" name="custom_cost_fdm" id="custom_cost_fdm" placeholder="Enter cost for 'Other' filament" min="0" step="0.001" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                    <div id="fdm-cost-display" class="p-4 bg-gray-50 rounded-lg text-center hidden">
                        <p class="text-sm text-gray-600">Estimated Lab Cost: <span id="fdm-cost" class="font-bold text-lg text-indigo-600">$0.00</span></p>
                    </div>
                </div>

                <div id="resin-form" class="space-y-6 hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                        <div>
                            <label for="resin_printer" class="block text-sm font-medium text-gray-700 mb-1">Printer Model</label>
                            <select name="resin_printer" id="resin_printer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                                <option value="Form 4">Form 4</option>
                                <option value="Form 3L">Form 3L</option>
                            </select>
                        </div>
                        <div>
                            <label for="resin_type" class="block text-sm font-medium text-gray-700 mb-1">Resin Type</label>
                            <select name="resin_type" id="resin_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition"></select>
                        </div>
                    </div>
                     <div id="other_resin_type_wrapper" class="hidden">
                        <label for="other_resin_type" class="block text-sm font-medium text-gray-700 mb-1">Specify Other Resin</label>
                        <input type="text" name="other_resin_type" id="other_resin_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="resin_amount" class="block text-sm font-medium text-gray-700 mb-1">Resin Amount (ml)</label>
                            <input type="number" name="resin_amount" id="resin_amount" min="0" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Resin Source</label>
                            <div id="resin_source_group" class="flex flex-wrap items-center gap-x-6 gap-y-2 pt-1">
                                <label class="flex items-center"><input type="radio" name="resin_source" value="Lab" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked> <span class="ml-2 text-sm text-gray-600">Lab</span></label>
                                <label class="flex items-center"><input type="radio" name="resin_source" value="Class" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-2 text-sm text-gray-600">Class</span></label>
                                <label class="flex items-center"><input type="radio" name="resin_source" value="Club" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-2 text-sm text-gray-600">Club</span></label>
                                <label class="flex items-center"><input type="radio" name="resin_source" value="Personal" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"> <span class="ml-2 text-sm text-gray-600">Personal</span></label>
                            </div>
                        </div>
                    </div>
                    <div id="custom_cost_resin_wrapper" class="hidden">
                        <label for="custom_cost_resin" class="block text-sm font-medium text-gray-700 mb-1">Custom Cost per mL ($)</label>
                        <input type="number" name="custom_cost_resin" id="custom_cost_resin" placeholder="Enter cost for 'Other' resin" min="0" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                    <div id="resin-cost-display" class="p-4 bg-gray-50 rounded-lg text-center hidden">
                        <p class="text-sm text-gray-600">Estimated Lab Cost: <span id="resin-cost" class="font-bold text-lg text-indigo-600">$0.00</span></p>
                    </div>
                </div>

                <div class="pt-4 flex items-center justify-between">
                    <a href="/receipts" class="w-1/3 text-center bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-transform transform hover:scale-105">
                        View All Receipts
                    </a>
                    <button type="submit" class="w-1/2 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                        Log Job & Print Receipt
                    </button>
                </div>
            </form>
        </div>
    </div>

<script>
    // --- Data from Flask ---
    const fdmCosts = JSON.parse('{{ costs.FDM_COSTS | tojson | safe }}');
    const resinCostPerMl = JSON.parse('{{ costs.RESIN_COST_PER_ML | tojson | safe }}');
    const resinOptionsByPrinter = JSON.parse('{{ costs.MATERIAL_TYPES | tojson | safe }}');

    // --- DOM Element References ---
    const fdmTab = document.getElementById('fdm-tab');
    const resinTab = document.getElementById('resin-tab');
    const printTypeInput = document.getElementById('print_type');
    
    // FDM Elements
    const fdmForm = document.getElementById('fdm-form');
    const filamentTypeSelect = document.getElementById('filament_type');
    const otherFilamentWrapper = document.getElementById('other_filament_type_wrapper');
    const filamentAmountInput = document.getElementById('filament_amount');
    const customCostFdmWrapper = document.getElementById('custom_cost_fdm_wrapper');
    const customCostFdmInput = document.getElementById('custom_cost_fdm');
    const fdmCostDisplay = document.getElementById('fdm-cost-display');
    const fdmCostEl = document.getElementById('fdm-cost');

    // Resin Elements
    const resinForm = document.getElementById('resin-form');
    const resinPrinterSelect = document.getElementById('resin_printer'); 
    const resinTypeSelect = document.getElementById('resin_type');
    const otherResinWrapper = document.getElementById('other_resin_type_wrapper');
    const resinAmountInput = document.getElementById('resin_amount');
    const customCostResinWrapper = document.getElementById('custom_cost_resin_wrapper');
    const customCostResinInput = document.getElementById('custom_cost_resin');
    const resinCostDisplay = document.getElementById('resin-cost-display');
    const resinCostEl = document.getElementById('resin-cost');

    // --- Functions ---
    function showForm(type) {
        const isFDM = type === 'FDM';
        fdmForm.style.display = isFDM ? 'block' : 'none';
        resinForm.style.display = isFDM ? 'none' : 'block';
        fdmTab.classList.toggle('tab-active', isFDM);
        fdmTab.classList.toggle('tab-inactive', !isFDM);
        resinTab.classList.toggle('tab-active', !isFDM);
        resinTab.classList.toggle('tab-inactive', isFDM);
        printTypeInput.value = type;
    }

    function updateResinOptions() {
        const selectedPrinter = resinPrinterSelect.value;
        const options = resinOptionsByPrinter[selectedPrinter] || [];
        resinTypeSelect.innerHTML = ''; 
        
        options.forEach(optionText => {
            const option = document.createElement('option');
            option.value = optionText;
            option.textContent = optionText;
            resinTypeSelect.appendChild(option);
        });
        
        const otherOption = document.createElement('option');
        otherOption.value = 'Other';
        otherOption.textContent = 'Other';
        resinTypeSelect.appendChild(otherOption);
        
        toggleOtherAndCustomFields();
    }
    
    function toggleOtherAndCustomFields() {
        // --- FDM Logic ---
        const fdmSourceType = document.querySelector('input[name="filament_source"]:checked').value;
        const isFdmOther = filamentTypeSelect.value === 'Other';
        // Show "Specify Other" text input if "Other" is selected
        otherFilamentWrapper.classList.toggle('hidden', !isFdmOther);
        // Show "Custom Cost" input only if "Other" is selected AND source is "Lab"
        customCostFdmWrapper.classList.toggle('hidden', !(isFdmOther && fdmSourceType === 'Lab'));
        
        if (!isFdmOther) {
             document.getElementById('other_filament_type').value = '';
        }
        
        // --- Resin Logic ---
        const resinSourceType = document.querySelector('input[name="resin_source"]:checked').value;
        const isResinOther = resinTypeSelect.value === 'Other';
        // Show "Specify Other" text input if "Other" is selected
        otherResinWrapper.classList.toggle('hidden', !isResinOther);
        // Show "Custom Cost" input only if "Other" is selected AND source is "Lab"
        customCostResinWrapper.classList.toggle('hidden', !(isResinOther && resinSourceType === 'Lab'));

        if (!isResinOther) {
            document.getElementById('other_resin_type').value = '';
        }

        // Recalculate costs whenever visibility changes
        calculateFdmCost();
        calculateResinCost();
    }

    function calculateFdmCost() {
        const sourceType = document.querySelector('input[name="filament_source"]:checked').value;
        if (sourceType !== 'Lab') {
            fdmCostDisplay.classList.add('hidden');
            return;
        }

        const filamentType = filamentTypeSelect.value;
        const amount = parseFloat(filamentAmountInput.value) || 0;
        let totalCost = 0;

        if (filamentType === 'Other') {
            const customRate = parseFloat(customCostFdmInput.value) || 0;
            totalCost = amount * customRate;
        } else {
            const costPerGram = fdmCosts[filamentType] || 0;
            totalCost = amount * costPerGram;
        }

        if (amount > 0) {
            fdmCostEl.textContent = `$${totalCost.toFixed(2)}`;
            fdmCostDisplay.classList.remove('hidden');
        } else {
            fdmCostDisplay.classList.add('hidden');
        }
    }

    function calculateResinCost() {
        const sourceType = document.querySelector('input[name="resin_source"]:checked').value;
        if (sourceType !== 'Lab') {
            resinCostDisplay.classList.add('hidden');
            return;
        }
        
        const resinType = resinTypeSelect.value;
        const amount = parseFloat(resinAmountInput.value) || 0;
        let totalCost = 0;

        if (resinType === 'Other') {
            const customRate = parseFloat(customCostResinInput.value) || 0;
            totalCost = amount * customRate;
        } else {
            totalCost = amount * resinCostPerMl;
        }

        if (amount > 0) {
            resinCostEl.textContent = `$${totalCost.toFixed(2)}`;
            resinCostDisplay.classList.remove('hidden');
        } else {
            resinCostDisplay.classList.add('hidden');
        }
    }

    // --- Initial Setup and Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        // Initial setup on page load
        showForm('FDM');
        updateResinOptions();
        
        // --- FDM Listeners ---
        filamentTypeSelect.addEventListener('change', toggleOtherAndCustomFields);
        filamentAmountInput.addEventListener('input', calculateFdmCost);
        customCostFdmInput.addEventListener('input', calculateFdmCost);
        // Add listener to all source radio buttons to re-check field visibility
        document.querySelectorAll('input[name="filament_source"]').forEach(radio => {
            radio.addEventListener('change', toggleOtherAndCustomFields);
        });

        // --- Resin Listeners ---
        resinPrinterSelect.addEventListener('change', updateResinOptions);
        resinTypeSelect.addEventListener('change', toggleOtherAndCustomFields);
        resinAmountInput.addEventListener('input', calculateResinCost);
        customCostResinInput.addEventListener('input', calculateResinCost);
        // Add listener to all source radio buttons to re-check field visibility
        document.querySelectorAll('input[name="resin_source"]').forEach(radio => {
            radio.addEventListener('change', toggleOtherAndCustomFields);
        });
    });
</script>

</body>
</html>